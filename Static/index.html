<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>RAG Policy Agent</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f6f7fb; }
    .container { max-width: 980px; margin: 0 auto; padding: 16px; }
    .header { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap: wrap; }
    .card { background: white; border-radius: 12px; padding: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); }
    #chat { height: 62vh; overflow-y: auto; padding: 12px; border: 1px solid #eee; border-radius: 10px; background:#fff; }
    .msg { margin: 10px 0; display:flex; }
    .msg.user { justify-content:flex-end; }
    .bubble { max-width: 78%; padding: 10px 12px; border-radius: 14px; line-height: 1.35; white-space: pre-wrap; }
    .user .bubble { background: #2563eb; color: white; border-bottom-right-radius: 6px; }
    .bot .bubble { background: #f1f5f9; color: #0f172a; border-bottom-left-radius: 6px; }
    .row { display:flex; gap:10px; margin-top: 10px; flex-wrap: wrap; }
    input, select, button { padding: 10px; border-radius: 10px; border: 1px solid #ddd; }
    input[type="text"] { flex: 1; min-width: 260px; }
    button { cursor:pointer; background:#111827; color:white; border:none; }
    button.secondary { background: #334155; }
    .small { font-size: 12px; color: #64748b; margin-top: 8px; }
    details { margin-top: 8px; }
    code { background:#eef2ff; padding:2px 6px; border-radius:6px; }
    .pill { display:inline-block; font-size:12px; padding:4px 8px; background:#eef2ff; border-radius:999px; margin-left:6px; color:#334155; }
    .topbar { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="topbar">
        <h2 style="margin:0;">ðŸ§  RAG Policy Agent</h2>
        <span class="pill">Pinecone embeddings</span>
        <span class="pill">OpenAI generation</span>
      </div>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <label for="docId"><b>Doc ID filter:</b></label>
        <input id="docId" placeholder="e.g., HR-003 (optional)" style="width:190px;" />

        <label for="mode"><b>Mode:</b></label>
        <select id="mode">
          <option value="generate" selected>Generate (RAG)</option>
          <option value="search">Search only</option>
        </select>

        <button class="secondary" onclick="clearChat()">Clear</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div id="chat"></div>

      <div class="row">
        <input id="q" type="text" placeholder="Ask a question about policies/SOPs..." />
        <button onclick="send()">Send</button>
      </div>

      <div class="small">
        <div>Generate mode calls <code>/generate</code> (retrieval + OpenAI). Search mode calls <code>/search</code> (retrieval only).</div>
        <div>If OpenAI key is missing, Generate will fail; Search will still work.</div>
      </div>
    </div>
  </div>

<script>
const chat = document.getElementById("chat");
const q = document.getElementById("q");
const docId = document.getElementById("docId");
const mode = document.getElementById("mode");

function addMsg(text, who, citations=null) {
  const wrap = document.createElement("div");
  wrap.className = "msg " + who;

  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.textContent = text;

  wrap.appendChild(bubble);
  chat.appendChild(wrap);

  if (who === "bot" && citations && citations.length) {
    const details = document.createElement("details");
    const summary = document.createElement("summary");
    summary.textContent = "Sources / Citations";
    details.appendChild(summary);

    const pre = document.createElement("pre");
    pre.style.whiteSpace = "pre-wrap";
    pre.textContent = JSON.stringify(citations, null, 2);
    details.appendChild(pre);

    chat.appendChild(details);
  }

  chat.scrollTop = chat.scrollHeight;
}

function clearChat() {
  chat.innerHTML = "";
  addMsg("Hi! Ask me about the ingested policy/SOP documents. You can optionally filter by Doc ID.", "bot");
}

async function send() {
  const text = q.value.trim();
  if (!text) return;

  addMsg(text, "user");
  q.value = "";

  const payload = {
    query: text,
    doc_id: docId.value.trim() || null,
    top_k: 5
  };

  const endpoint = mode.value === "search" ? "/search" : "/generate";

  try {
    const res = await fetch(endpoint, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const err = await res.text();
      addMsg("Error: " + err, "bot");
      return;
    }

    const data = await res.json();

    if (endpoint === "/search") {
      const matches = data.matches || [];
      if (!matches.length) {
        addMsg("No matches found.", "bot");
        return;
      }
      const preview = matches.slice(0, 5).map(m => {
        const md = m.metadata || {};
        return `â€¢ score=${m.score.toFixed(4)} doc_id=${md.doc_id} file=${md.file_name} chunk=${md.chunk_index}`;
      }).join("\n");
      addMsg("Top matches:\n" + preview, "bot", matches.slice(0, 5));
    } else {
      addMsg(data.answer || "(no answer)", "bot", data.citations || []);
    }

  } catch (e) {
    addMsg("Network error: " + e.message, "bot");
  }
}

q.addEventListener("keydown", (e) => {
  if (e.key === "Enter") send();
});

// welcome
clearChat();
</script>
</body>
</html>
